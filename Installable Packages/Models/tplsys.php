<?php/* * @author * Name: Mostafa Shalkami * Email: info[at]sobimarket.net * @copyright Copyright (C) 2013 Mostafa Shalkami. All rights reserved. * @license see http://www.gnu.org/licenses/gpl.html GNU/GPL Version 3. * You can use, redistribute this file and/or modify it under the terms of the GNU General Public License version 3 */defined('SOBIPRO') || exit('Restricted access');SPLoader::loadModel('datamodel');SPLoader::loadModel('dbobject');class SPTplsysModel extends SPDBObject implements SPDataModel {    /**     * @var string     */    protected $_type = 'tplsys';    private function sectionFields() {        $db = & SPFactory::db();        $sid = Sobi::Reg('current_section');        try {            $db->select('*', 'spdb_field', array('section' => $sid), 'position.asc');            $results = $db->loadObjectList();        } catch (SPException $x) {            Sobi::Error($this->name(), SPLang::e('DB_REPORTS_ERR', $x->getMessage()), SPC::WARNING, 0, __LINE__, __FILE__);        }        $fields = array();        if (count($results)) {            foreach ($results as $result) {                $field = SPFactory::Model('field', true);                $field->extend($result);                if ($field->get('enabled'))                    $fields[] = $field;            }        }        return $fields;    }    public function getCfg() {        $tplPckg = Sobi::Cfg('section.template', 'default');        $cfg = SPLoader::loadIniFile("usr.templates.{$tplPckg}.config");        return $cfg;    }    public function write_ini_file($options) {        $tplPckg = Sobi::Cfg('section.template', 'default');        $file = SOBI_PATH . DS . 'usr' . DS . 'templates' . DS . $tplPckg . DS . 'config.ini';        $tmp = '';        foreach ($options as $section => $values) {            $tmp .= "[$section]\n";            foreach ($values as $key => $val) {                if (is_array($val)) {                    foreach ($val as $k => $v) {                        $tmp .= "{$key}[$k] = \"$v\"\n";                    }                }                else                    $tmp .= "$key = \"$val\"\n";            }            $tmp .= "\n";        }        $fh = fopen($file, 'w') or die("can't open file");        ;        fwrite($fh, $tmp);        fclose($fh);        unset($tmp);    }    public function fields($view) {        $fields = $this->sectionFields();        $positions = array();        foreach ($fields as $field) {            if (($field->get('showIn') == $view || $field->get('showIn') == 'both'))                $positions[$field->get('fid') . "|" . $field->get('nid')] = $field->get('name') . " [" . $field->get('nid') . "]";            elseif ($view == 'edit')                $positions[$field->get('fid') . "|" . $field->get('nid')] = $field->get('name') . " [" . $field->get('nid') . "]";        }        return $positions;    }}